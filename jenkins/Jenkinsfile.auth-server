// auth-server ì „ìš© ë°°í¬ íŒŒì´í”„ë¼ì¸
// ì¸ì¦ ì„œë²„ì˜ ë¹Œë“œ, í…ŒìŠ¤íŠ¸, ë°°í¬ë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤.

@Library('krgeobuk-shared-library') _

pipeline {
    agent any

    parameters {
        choice(
            name: 'ENVIRONMENT',
            choices: ['dev', 'prod'],
            description: 'ë°°í¬ í™˜ê²½'
        )
        string(
            name: 'GIT_BRANCH',
            defaultValue: 'dev',
            description: 'Git ë¸Œëœì¹˜ (dev: dev ë¸Œëœì¹˜, prod: main ë¸Œëœì¹˜)'
        )
        booleanParam(
            name: 'SKIP_TESTS',
            defaultValue: false,
            description: 'í…ŒìŠ¤íŠ¸ ê±´ë„ˆë›°ê¸°'
        )
        booleanParam(
            name: 'RUN_E2E_TESTS',
            defaultValue: false,
            description: 'E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰'
        )
    }

    environment {
        SERVICE_NAME = 'auth-server'
        DOCKER_REGISTRY = 'krgeobuk'
        DOCKER_CREDENTIALS_ID = 'docker-registry-credentials'

        // Git ì„¤ì •
        GIT_REPO = 'https://github.com/your-org/auth-server.git'
        GIT_CREDENTIALS_ID = 'github-credentials'

        // ë¹Œë“œ ì •ë³´
        BUILD_TIMESTAMP = sh(script: "date +%Y%m%d-%H%M%S", returnStdout: true).trim()
        GIT_COMMIT_SHORT = sh(script: "git rev-parse --short HEAD", returnStdout: true).trim()
        IMAGE_TAG = "${BUILD_TIMESTAMP}-${GIT_COMMIT_SHORT}"

        // K8s ì„¤ì •
        K8S_NAMESPACE = params.ENVIRONMENT == 'prod' ? 'krgeobuk-prod' : 'krgeobuk-dev'
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '30'))
        timestamps()
        timeout(time: 30, unit: 'MINUTES')
    }

    stages {
        stage('ğŸ“‹ Prepare') {
            steps {
                script {
                    echo """
                    =========================================
                    auth-server ë°°í¬ íŒŒì´í”„ë¼ì¸
                    =========================================
                    í™˜ê²½: ${params.ENVIRONMENT}
                    ë¸Œëœì¹˜: ${params.GIT_BRANCH}
                    ë„¤ì„ìŠ¤í˜ì´ìŠ¤: ${env.K8S_NAMESPACE}
                    ì´ë¯¸ì§€ íƒœê·¸: ${env.IMAGE_TAG}
                    =========================================
                    """
                }
            }
        }

        stage('ğŸ” Checkout') {
            steps {
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${params.GIT_BRANCH}"]],
                    userRemoteConfigs: [[
                        url: env.GIT_REPO,
                        credentialsId: env.GIT_CREDENTIALS_ID
                    ]]
                ])
            }
        }

        stage('ğŸ“¦ Install Dependencies') {
            steps {
                sh '''
                    echo "Installing dependencies..."
                    npm ci
                '''
            }
        }

        stage('ğŸ§ª Run Tests') {
            when {
                expression { !params.SKIP_TESTS }
            }
            parallel {
                stage('Unit Tests') {
                    steps {
                        sh '''
                            echo "Running unit tests..."
                            npm run test
                        '''
                    }
                }
                stage('Lint') {
                    steps {
                        sh '''
                            echo "Running linter..."
                            npm run lint
                        '''
                    }
                }
            }
        }

        stage('ğŸ§ª E2E Tests') {
            when {
                expression { params.RUN_E2E_TESTS }
            }
            steps {
                sh '''
                    echo "Running E2E tests..."
                    npm run test:e2e
                '''
            }
        }

        stage('ğŸ—ï¸ Build') {
            steps {
                sh '''
                    echo "Building application..."
                    npm run build
                '''
            }
        }

        stage('ğŸ³ Build Docker Image') {
            steps {
                script {
                    buildImage(
                        serviceName: env.SERVICE_NAME,
                        imageTag: env.IMAGE_TAG,
                        dockerRegistry: env.DOCKER_REGISTRY,
                        additionalTags: params.ENVIRONMENT == 'prod' ? ['latest'] : []
                    )
                }
            }
        }

        stage('ğŸš€ Deploy to Kubernetes') {
            steps {
                script {
                    // Production ë°°í¬ëŠ” ìˆ˜ë™ ìŠ¹ì¸ í•„ìš”
                    if (params.ENVIRONMENT == 'prod') {
                        input message: 'Production í™˜ê²½ì— ë°°í¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                              ok: 'Deploy to Production',
                              submitter: 'admin,devops'
                    }

                    // K8s ë°°í¬
                    deployToK8s(
                        environment: params.ENVIRONMENT,
                        service: env.SERVICE_NAME,
                        imageTag: env.IMAGE_TAG,
                        namespace: env.K8S_NAMESPACE
                    )
                }
            }
        }

        stage('âœ… Verify Deployment') {
            steps {
                script {
                    echo "Verifying deployment..."
                    sh """
                        kubectl rollout status deployment/${env.SERVICE_NAME} -n ${env.K8S_NAMESPACE} --timeout=5m
                        kubectl get pods -n ${env.K8S_NAMESPACE} -l app=${env.SERVICE_NAME}
                    """
                }
            }
        }

        stage('ğŸ” Health Check') {
            steps {
                script {
                    echo "Running health check..."
                    sh """
                        # Podê°€ Ready ìƒíƒœì¸ì§€ í™•ì¸
                        kubectl wait --for=condition=ready pod -l app=${env.SERVICE_NAME} -n ${env.K8S_NAMESPACE} --timeout=300s

                        # Health ì—”ë“œí¬ì¸íŠ¸ í™•ì¸
                        POD_NAME=\$(kubectl get pod -n ${env.K8S_NAMESPACE} -l app=${env.SERVICE_NAME} -o jsonpath='{.items[0].metadata.name}')
                        kubectl exec \$POD_NAME -n ${env.K8S_NAMESPACE} -- curl -f http://localhost:8000/health || exit 1
                    """
                }
            }
        }
    }

    post {
        success {
            script {
                notifySlack(
                    status: 'SUCCESS',
                    environment: params.ENVIRONMENT,
                    service: env.SERVICE_NAME,
                    message: """
                    âœ… auth-server ë°°í¬ ì„±ê³µ
                    í™˜ê²½: ${params.ENVIRONMENT}
                    ì´ë¯¸ì§€: ${env.DOCKER_REGISTRY}/${env.SERVICE_NAME}:${env.IMAGE_TAG}
                    ë„¤ì„ìŠ¤í˜ì´ìŠ¤: ${env.K8S_NAMESPACE}
                    """.stripIndent()
                )
            }
        }
        failure {
            script {
                notifySlack(
                    status: 'FAILURE',
                    environment: params.ENVIRONMENT,
                    service: env.SERVICE_NAME,
                    message: """
                    âŒ auth-server ë°°í¬ ì‹¤íŒ¨
                    í™˜ê²½: ${params.ENVIRONMENT}
                    ì—ëŸ¬ í™•ì¸: ${env.BUILD_URL}console
                    """.stripIndent()
                )
            }
        }
        always {
            // í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë³´ê´€
            junit allowEmptyResults: true, testResults: '**/test-results/**/*.xml'

            // ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì •ë¦¬
            cleanWs(
                deleteDirs: true,
                patterns: [
                    [pattern: 'node_modules', type: 'INCLUDE'],
                    [pattern: 'dist', type: 'INCLUDE']
                ]
            )
        }
    }
}
